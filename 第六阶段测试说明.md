# 第六阶段测试说明 - 对话交互

## 功能概述

第六阶段实现了自然语言对话交互功能，用户可以通过对话与精灵进行更复杂的文件操作。

### 核心功能

1. **对话窗口**: 双击精灵打开对话界面
2. **自然语言指令**: 支持中文对话
3. **快捷指令**: 常用操作一键触发
4. **智能解析**: AI 理解用户意图并执行
5. **对话历史**: 自动保存聊天记录

## 使用指南

### 打开对话窗口

**方法1**: 双击精灵（快速连续点击两次）

**效果**: 在主窗口右侧弹出对话窗口

### 对话界面

```
┌─────────────────────────────┐
│ 🎀 MoeGui 助手              │ ← 标题栏
├─────────────────────────────┤
│ 📁 整理桌面 | 🕒 最近文件... │ ← 快捷按钮
├─────────────────────────────┤
│                             │
│  👤 帮我整理桌面             │ ← 用户消息
│                             │
│  🎀 好的，马上帮你整理！     │ ← AI 回复
│                             │
├─────────────────────────────┤
│ [输入框]              [发送]│ ← 输入区
└─────────────────────────────┘
```

### 快捷按钮

| 按钮 | 功能 |
|------|------|
| 📁 整理桌面 | 一键整理所有桌面文件 |
| 🕒 最近文件 | 查看最近修改的文件 |
| 🗑️ 清理重复 | 查找并清理重复文件（开发中）|
| 📅 按日期归档 | 按文件日期自动归档 |
| ❓ 帮助 | 显示帮助信息 |

## 支持的指令

### 1. 文件整理指令

**示例**:
- "帮我整理桌面"
- "整理一下文件"
- "把桌面文件分类"

**AI 行为**:
1. 分析桌面所有文件
2. 调用 AI 分类接口
3. 创建文件夹并移动文件
4. 返回整理结果

### 2. 文件查找指令

**示例**:
- "找找图片"
- "查找最近的文档"
- "有哪些 PDF 文件"

**AI 行为**:
1. 搜索桌面文件
2. 返回匹配的文件列表
3. 最多显示 10 个结果

### 3. 普通对话

**示例**:
- "你好"
- "你能做什么"
- "帮帮我"

**AI 行为**:
直接回复，不执行文件操作

## AI Prompt 设计

### 对话 Prompt 结构

```
你是 MoeGui 桌面精灵助手。你可以帮助用户整理文件、查找文件和管理桌面。

用户指令：帮我整理桌面

当前桌面文件：文件1.txt, 文件2.jpg, 文件3.docx

请分析用户意图并回复。如果用户想要执行文件操作，返回 JSON 格式：
{
  "message": "好的，马上帮你整理桌面！",
  "action": {
    "type": "organize_desktop",
    "params": {}
  }
}

如果只是普通对话，直接返回文本回复即可。
```

### 响应类型

**1. 带动作的响应（JSON）**:
```json
{
  "message": "好的，我来帮你查找图片文件",
  "action": {
    "type": "find_files",
    "params": { "keyword": "图片" }
  }
}
```

**2. 纯文本响应**:
```
你好！我是 MoeGui，可以帮你整理桌面文件哦～
```

## 测试用例

### 测试 1: 对话基础功能

**步骤**:
1. 双击精灵打开对话窗口
2. 输入 "你好"
3. 观察 AI 回复

**预期结果**:
- 对话窗口正常打开
- AI 回复友好的问候语
- 消息正确显示在界面上

### 测试 2: 整理桌面指令

**步骤**:
1. 在桌面放置几个测试文件
2. 打开对话窗口
3. 输入 "帮我整理桌面" 或点击 "📁 整理桌面" 按钮
4. 等待处理完成

**预期结果**:
- 显示 "AI 正在分析文件..."
- 显示 "🔄 正在整理桌面..."
- 桌面文件被分类整理
- 显示成功消息（如 "✨ 整理完成：创建了 3 个文件夹"）

### 测试 3: 查找文件指令

**步骤**:
1. 打开对话窗口
2. 输入 "找找图片文件"
3. 等待结果

**预期结果**:
- 显示 "🔍 正在查找文件..."
- 列出找到的图片文件
- 最多显示 10 个

### 测试 4: 对话历史

**步骤**:
1. 进行几轮对话
2. 关闭对话窗口
3. 重新打开对话窗口

**预期结果**:
- 之前的对话记录仍然存在
- 消息顺序正确
- 可以继续对话

### 测试 5: 快捷按钮

**步骤**:
1. 依次点击各个快捷按钮
2. 观察执行效果

**预期结果**:
- 每个按钮触发对应的功能
- 用户消息自动填充
- AI 正确响应

## 文件结构

```
src/
├── main/
│   ├── index.js           🔄 添加对话窗口管理
│   └── ai-service.js      🔄 添加对话 AI 处理
├── preload/index.js       🔄 添加对话 API
└── renderer/
    ├── chat.html          ✨ 对话界面
    ├── chat.js            ✨ 对话逻辑
    └── interaction.js     🔄 双击打开对话
```

## 交互流程

```
用户双击精灵
    ↓
打开对话窗口
    ↓
用户输入指令
    ↓
发送到主进程
    ↓
AI 分析意图
    ↓
┌─────────────┐
│ 纯文本回复？ │
└──┬────────┬──┘
   Yes      No
    │        │
    │    解析动作
    │        │
    │    执行操作
    │        │
    └────┬───┘
         │
    显示结果
         │
    保存历史
```

## 调试技巧

### 查看对话日志

打开开发者工具（托盘 → 开发者工具）查看控制台：

```javascript
// 用户消息
console.log('用户消息:', message);

// AI 响应
console.log('AI 响应:', response);

// 执行动作
console.log('执行动作:', action);
```

### 对话历史位置

配置文件: `%APPDATA%/moe-gui/config.json`

```json
{
  "chatHistory": [
    {
      "role": "user",
      "content": "帮我整理桌面",
      "timestamp": 1703750400000
    },
    {
      "role": "assistant",
      "content": "好的，马上帮你整理！",
      "timestamp": 1703750402000
    }
  ]
}
```

### 清空对话历史

删除配置文件中的 `chatHistory` 字段即可。

## 常见问题

### Q: 双击无反应

**A**: 检查：
- 是否点击在精灵实体上（不是透明区域）
- 两次点击间隔是否 < 300ms
- 控制台是否有错误

### Q: AI 不理解指令

**A**:
- 尝试更明确的表达（如 "整理桌面文件" 而不是 "整理"）
- 查看控制台 AI 响应内容
- 检查 API Key 配置

### Q: 对话窗口位置不对

**A**: 窗口位置默认在主窗口右侧，可以手动拖动调整。

## 下一步

第七阶段将进行最终打磨和发布准备：
- 开机自启动
- 设置面板优化
- 性能优化
- 打包发布
