# 第五阶段测试说明 - AI 智能分类

## 安装依赖

在运行之前，请先安装新的依赖：

```bash
npm install electron-fetch
```

## 配置 AI 服务

### 1. 打开设置面板

运行应用后，在系统托盘右键点击图标，选择 **"AI 设置"**。

### 2. 配置参数

填写以下信息：

- **AI 模型**: 选择一个模型（推荐 Gemini 3.0 Flash，速度快且便宜）
- **API 端点**: `https://action.h7ml.cn` （默认值，兼容 OpenAI 格式）
- **API Key**: 输入您的 API 密钥

点击 **"保存设置"**。

### 3. API Key 获取

如果使用参考的端点 `https://action.h7ml.cn`，您需要：
- 访问相应的平台获取 API Key
- 或者使用其他兼容 OpenAI 格式的 API 端点（如 OpenAI、Azure OpenAI 等）

## 功能测试

### 测试 1: 基础文件分类

**操作步骤**:
1. 在桌面创建几个测试文件：
   ```
   项目报告.docx
   会议记录.txt
   照片1.jpg
   照片2.png
   数据分析.xlsx
   代码示例.js
   ```

2. 将这些文件拖放到精灵窗口

3. 观察效果：
   - 窗口显示 "AI 正在分析文件..."
   - 精灵播放动画
   - 完成后显示成功消息
   - 桌面自动创建分类文件夹（如"文档"、"图片"、"代码"）
   - 文件被移动到对应文件夹

**预期结果**:
- AI 根据文件类型和名称智能分类
- 自动创建合理的文件夹名称（中文）
- 所有文件被正确归档

### 测试 2: 主题分类

**操作步骤**:
1. 创建一些有明确主题的文件：
   ```
   年度总结-2024.docx
   年度总结-数据.xlsx
   年度总结-图表.png
   培训资料-PPT.pptx
   培训资料-视频.mp4
   ```

2. 拖放到精灵

**预期结果**:
- AI 识别出主题（年度总结、培训资料）
- 按主题而非文件类型分类
- 创建"年度总结"、"培训资料"等文件夹

### 测试 3: 错误处理

**测试场景**:
- **未配置 API**: 拖放文件时显示 "AI 服务未配置，请在托盘菜单中设置"
- **API Key 错误**: 显示 API 错误信息
- **网络错误**: 显示 "处理失败" 消息

## AI Prompt 工作原理

### 输入格式

```
你是一个智能文件整理助手。请根据文件名、扩展名和类型，对以下文件进行分类整理。

文件列表：
1. 项目报告.docx (.docx, 25.3 KB)
2. 照片1.jpg (.jpg, 2.1 MB)
3. 代码示例.js (.js, 5.2 KB)

请按照以下规则进行分类：
1. 根据文件类型分类（文档、图片、视频、音频、压缩包、代码等）
2. 如果文件名包含明确的主题或项目名称，优先按主题分类
3. 相同类型的文件归入同一文件夹
4. 文件夹名称要简洁、清晰、中文

请以 JSON 格式返回...
```

### 输出格式

```json
{
  "action": "ORGANIZE",
  "folders": [
    {
      "name": "文档",
      "description": "包含各类办公文档",
      "files": ["项目报告.docx"]
    },
    {
      "name": "图片",
      "description": "照片和图片文件",
      "files": ["照片1.jpg"]
    },
    {
      "name": "代码",
      "description": "JavaScript 代码文件",
      "files": ["代码示例.js"]
    }
  ],
  "summary": "整理完成：创建了 3 个文件夹"
}
```

## 文件整理逻辑

src/main/index.js:409

1. **接收文件信息** → AI 分析
2. **解析 JSON 响应** → 验证格式
3. **创建文件夹** → `fs.mkdirSync()`
4. **移动文件** → `fs.renameSync()`
5. **返回结果** → 渲染进程显示

## 调试技巧

### 查看 AI 请求和响应

打开开发者工具（托盘 → 开发者工具）：

```javascript
// 控制台会输出：
// - "开始 AI 分析文件..."
// - "AI 分类结果: {...}"
// - "创建文件夹: 文档"
// - "移动文件: 项目报告.docx -> 文档/"
```

### 查看配置文件

配置保存位置: `%APPDATA%/moe-gui/config.json`

```json
{
  "apiModel": "gemini-3-flash-preview",
  "apiBaseUrl": "https://action.h7ml.cn",
  "apiKey": "your-api-key-here",
  "windowPosition": { "x": 100, "y": 100 }
}
```

## 常见问题

### Q: AI 返回了错误的 JSON 格式

**A**: 降低 temperature 参数（目前是 0.3），或者在 Prompt 中更明确地要求纯 JSON 输出。

### Q: 文件移动失败

**A**: 检查：
- 文件是否被其他程序占用
- 目标文件夹是否有写入权限
- 文件名是否包含特殊字符

### Q: API 调用太慢

**A**:
- 切换到更快的模型（如 Gemini Flash）
- 使用国内的 API 代理
- 减少一次性拖放的文件数量

## 性能优化建议

1. **批量处理**: 一次拖放多个文件，而不是逐个拖放
2. **缓存策略**: 可以缓存常见文件类型的分类规则（未实现）
3. **本地优先**: 对于明确的文件类型（.jpg .mp4），可以先本地分类，只有模糊情况才调用 AI（未实现）

## 下一步

第六阶段将实现对话交互功能，可以通过自然语言与精灵对话，执行更复杂的文件操作。
